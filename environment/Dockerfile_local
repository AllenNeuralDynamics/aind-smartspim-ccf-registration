# ------------------- #
#   Stage 1: Builder  #
# ------------------- #
FROM condaforge/miniforge3:latest as builder

ARG DEBIAN_FRONTEND=noninteractive
ENV CONDA_ENV=ccf_reg
ENV PATH=/opt/conda/envs/$CONDA_ENV/bin:$PATH

# Install only what's needed to build packages (temporarily)
RUN apt-get update && \
    apt-get install -y --no-install-recommends gcc g++ build-essential && \
    rm -rf /var/lib/apt/lists/*

# Create env and install packages
RUN conda create -n $CONDA_ENV python=3.8 -y && \
    /opt/conda/envs/$CONDA_ENV/bin/pip install -U --no-cache-dir \
    antspyx==0.4.2 \
    argschema==3.0.4 \
    s3fs==2022.11.0 \
    scikit-image==0.19.3 \
    tifffile==2022.10.10 \
    bokeh==2.4.2 \
    zarr==2.13.3 \
    aind-data-schema==1.0.0 \
    xarray_multiscale==1.1.0 \
    dask[distributed]==2022.11.1 \
    cloud-volume[all_codecs]==11.0.2 \
    matplotlib==3.7.3 \
    ome-zarr==0.8.2 \
    natsort==8.4.0 \
    crackle-codec==0.26.0 \
    aicsimageio@git+https://github.com/camilolaiton/aicsimageio.git@feature/zarrwriter-multiscales-daskjobs \
    awscli && \
    conda clean --all --yes

# ------------------- #
#   Stage 2: Runtime  #
# ------------------- #
FROM condaforge/miniforge3:latest

LABEL maintainer="Camilo Laiton <camilo.laiton@alleninstitute.org>" \
    org.opencontainers.image.title="Image Atlas Registration" \
    org.opencontainers.image.description="Container for registration of lightsheet images to the Allen CCF V3 atlas" \
    org.opencontainers.image.version="0.0.31" \
    org.opencontainers.image.licenses="MIT"

ENV CONDA_ENV=ccf_reg
ENV PATH=/opt/conda/envs/$CONDA_ENV/bin:$PATH

# Copy env from builder
COPY --from=builder /opt/conda /opt/conda

CMD ["bash"]
